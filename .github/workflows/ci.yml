name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  build-and-test:
    name: Build and Test
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Swift 6.0.3 を強制（macOS の古い Swift を無効化）
      - name: Set up Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.0.3"

      # brew で Linter / Formatter をインストール
      - name: Install SwiftLint & SwiftFormat
        run: |
          brew install swiftlint
          brew install swiftformat
          echo "/opt/homebrew/bin" >> $GITHUB_PATH

      # Lint 実行
      - name: Run SwiftLint
        run: swiftlint

      # Format チェック（自動整形はしない）
      - name: Check SwiftFormat
        run: swiftformat --lint .

      # SwiftPM をビルド（index-store 無効化で高速化）
      - name: Build
        run: swift build --configuration debug --disable-index-store

      # テスト（unsafeFlags を使用しているため SPM テストは実行不可）
      # executorch の -Wl,-all_load フラグが SPM のセキュリティ制限に抵触するため、
      # CI ではビルド検証のみ実施。完全なテストは Xcode で実行
      # - name: Test
      #   run: swift test --parallel --disable-index-store
