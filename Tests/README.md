# AbacusKit Tests

This directory contains the test suite for AbacusKit.

## Test Frameworks

- **Quick**: BDD-style testing framework
- **Nimble**: Expressive matcher library
- **Cuckoo**: Protocol-based automatic mock generation

## Mock Generation

Cuckoo is used to automatically generate mocks for protocols.

### Running Mock Generation

```bash
# Auto-generate during Swift Package Manager build
swift build

# Or generate manually
swift run cuckoo generate \
  --testable AbacusKit \
  --output Tests/AbacusKitTests/Generated
```

### Generated Mocks

Mocks are automatically generated for the following protocols:

- `MockModelManager`
- `MockModelUpdater`
- `MockModelVersionAPI`
- `MockS3Downloader`
- `MockFileStorage`
- `MockModelCache`
- `MockPreprocessor`

## Running Tests

```bash
# Run all tests
swift test

# Run specific tests
swift test --filter ModelVersionSpec

# Verbose output
swift test --verbose
```

## Test Structure

```
Tests/AbacusKitTests/
├── Core/
│   └── AbacusConfigTests.swift
├── Domain/
│   └── ModelVersionTests.swift
├── ML/
│   └── PreprocessorTests.swift
├── Networking/
│   └── ModelVersionAPITests.swift
├── Storage/
│   └── ModelCacheTests.swift
├── Generated/              # Auto-generated by Cuckoo
│   └── GeneratedMocks.swift
├── AbacusTests.swift
├── GenerateMocks.swift     # Mock generation marker
└── README.md
```

## Mock Usage Example

```swift
import Cuckoo
@testable import AbacusKit

class MyTests: QuickSpec {
    override class func spec() {
        describe("MyFeature") {
            var mockModelManager: MockModelManager!
            
            beforeEach {
                mockModelManager = MockModelManager()
            }
            
            it("should perform inference") {
                // Configure mock behavior
                stub(mockModelManager) { stub in
                    when(stub.predict(pixelBuffer: any())).thenReturn([42.0, 0.95])
                }
                
                // Execute test
                waitUntil { done in
                    Task {
                        let result = try await mockModelManager.predict(pixelBuffer: pixelBuffer)
                        expect(result).to(equal([42.0, 0.95]))
                        done()
                    }
                }
                
                // Verify invocation
                verify(mockModelManager).predict(pixelBuffer: any())
            }
        }
    }
}
```

## Best Practices

1. **Given-When-Then**: Divide tests into three clear phases
2. **One Assertion Per Test**: Each test verifies only one behavior
3. **Mock Isolation**: Use new mock instances for each test
4. **Async Testing**: Use `waitUntil` to properly wait for async operations
5. **Meaningful Names**: Test case names should clearly express behavior

## Troubleshooting

### Mocks Not Generated

```bash
# Clean cache
swift package clean
swift build
```

### Tests Timeout

```swift
// Extend timeout duration
waitUntil(timeout: .seconds(10)) { done in
    // ...
}
```

### Mock Behavior Not as Expected

```swift
// Enable debug output
stub(mockModelManager) { stub in
    when(stub.predict(pixelBuffer: any())).then { _ in
        print("Mock called!")
        return [42.0, 0.95]
    }
}
```
